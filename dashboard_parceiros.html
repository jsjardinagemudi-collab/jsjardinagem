<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#114084" />

  <title>Servi√ßos Dispon√≠veis ‚Ä¢ Portal do Parceiro ‚Ä¢ JS Jardinagem</title>
  <meta name="description" content="Dashboard estilo Uber para parceiros: visualize servi√ßos dispon√≠veis, filtre r√°pido e clique para pegar via formul√°rio." />

  <link rel="icon" href="/favicon.ico" />

  <style>
    :root{
      --pri:#114084;
      --pri2:#11804a;
      --ink:#0f1411;
      --muted:#667085;
      --paper:#fff;
      --bg:#f6f7f6;
      --line:#e7ecef;
      --warn:#b54708;
      --good:#027a48;
      --bad:#b42318;
      --shadow:0 10px 26px rgba(0,0,0,.06);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    }

    a{text-decoration:none;color:inherit}
    .wrap{width:min(1120px,92vw);margin:auto}

    .topbar{
      background:var(--pri);
      color:#fff;
      text-align:center;
      padding:8px 10px;
      font-size:14px;
      font-weight:800;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:#ffffffcc;
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid #eef0ee;
    }

    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 0;
      gap:16px;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .brand img{
      height:56px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
    }

    .brand strong{
      font-size:18px;
      font-weight:900;
      color:var(--pri);
      text-transform:uppercase;
    }

    .links{
      display:flex;
      gap:18px;
      font-weight:800;
    }
    .links a:hover{color:var(--pri)}

    .btn{
      appearance:none;
      border:1px solid #dfe3df;
      background:#fff;
      border-radius:12px;
      padding:12px 16px;
      font-weight:800;
      cursor:pointer;
      transition:.25s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{background:#f3f5f7}

    .btn-primary{
      background:var(--pri);
      border-color:var(--pri);
      color:#fff;
    }
    .btn-primary:hover{
      background:#0d3270;
      border-color:#0d3270;
    }
    .btn-ghost{
      background:transparent;
      border-color:#cfd8dc;
      color:var(--pri);
    }

    section{padding:44px 0}

    .hero{
      background:linear-gradient(120deg,var(--pri),var(--pri2));
      color:#fff;
      padding:54px 0;
    }

    .hero h1{
      margin:0 0 10px;
      font-size:clamp(26px,3.6vw,40px);
      letter-spacing:.2px;
    }

    .hero p{
      margin:0;
      opacity:.95;
      max-width:860px;
      line-height:1.6;
    }

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:16px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.28);
      border-radius:999px;
      background:rgba(255,255,255,.12);
      font-weight:800;
      font-size:13px;
    }

    .note{
      margin-top:16px;
      background:rgba(255,255,255,.14);
      border:1px dashed rgba(255,255,255,.28);
      border-radius:16px;
      padding:14px;
      color:#fff;
      line-height:1.55;
    }
    .note strong{color:#fff}

    /* Dashboard Layout */
    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:14px;
      margin-top:-26px;
    }

    .kpi{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      min-height:92px;
    }
    .kpi .t{margin:0 0 6px;color:var(--muted);font-weight:800;font-size:12px}
    .kpi .v{margin:0;font-weight:1000;font-size:20px;color:var(--pri)}
    .kpi .s{margin:8px 0 0;color:var(--muted);font-weight:700;font-size:12px}

    .dash{
      margin-top:18px;
      display:grid;
      grid-template-columns:1.25fr .75fr;
      gap:18px;
      align-items:start;
    }

    .panel{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .panel-head{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#fbfcfd;
    }
    .panel-head h2{
      margin:0;
      font-size:14px;
      font-weight:1000;
      color:var(--pri);
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .panel-head .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .conn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:99px;background:#f59f00}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}

    .filters{
      display:grid;
      grid-template-columns:1.2fr .9fr .9fr .9fr .9fr;
      gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid #dfe3df;
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:800;
    }
    .field input,.field select{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      font-weight:800;
      color:var(--ink);
    }
    .field input::placeholder{color:#98a2b3}

    .cards{
      padding:14px 16px 18px;
      display:grid;
      gap:12px;
    }

    .job{
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 8px 18px rgba(0,0,0,.05);
      padding:14px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:14px;
      align-items:center;
      transition:.2s ease;
    }
    .job:hover{
      transform:translateY(-4px);
      box-shadow:0 18px 40px rgba(0,0,0,.12);
      border-color:#cfe0f5;
    }

    .job h3{
      margin:0;
      color:var(--pri);
      line-height:1.2;
      font-size:15px;
    }
    .job .meta{
      margin-top:8px;
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:10px;
    }
    .kv{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:#fbfcfd;
    }
    .kv .k{margin:0 0 4px;color:var(--muted);font-weight:900;font-size:11px}
    .kv .v{margin:0;font-weight:900;font-size:13px;color:#344054}

    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:11px;
      border:1px solid var(--line);
      background:#fff;
      color:#344054;
    }
    .b-ok{border-color:#b7ebc8;background:#ecfdf3;color:var(--good)}
    .b-warn{border-color:#ffd7aa;background:#fffaeb;color:#b54708}
    .b-bad{border-color:#fecdca;background:#fef3f2;color:var(--bad)}
    .b-pri{border-color:#cfe0f5;background:#eff8ff;color:var(--pri)}
    .b-id{border-color:#e7ecef;background:#f9fafb;color:#475467}

    .cta{
      min-width:210px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    .price{
      text-align:right;
      font-weight:1000;
      color:var(--pri);
      font-size:18px;
      margin:0;
    }
    .sub{
      margin:-6px 0 0;
      text-align:right;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }

    .btn-take{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      background:linear-gradient(120deg,var(--pri),var(--pri2));
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      transition:.2s ease;
    }
    .btn-take:hover{filter:brightness(.98); transform:translateY(-1px)}
    .btn-take:active{transform:translateY(0px)}

    .btn-mini{
      border:1px solid #dfe3df;
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .btn-mini:hover{background:#f3f5f7}

    .empty{
      padding:18px 16px;
      color:var(--muted);
      font-weight:800;
      text-align:center;
      display:none;
    }

    /* Side */
    .side{
      position:sticky;
      top:96px;
      padding:14px;
    }

    .side .box{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .side h3{
      margin:0 0 8px;
      color:var(--pri);
      font-size:14px;
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:.2px;
    }
    .side p{
      margin:0;
      color:#475467;
      line-height:1.6;
      font-weight:700;
      font-size:13px;
    }
    .side ul{
      margin:10px 0 0;
      padding-left:18px;
      color:#475467;
      line-height:1.6;
      font-weight:700;
      font-size:13px;
    }
    .side .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .side code{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background:#f2f4f7;
      border:1px solid #e4e7ec;
      padding:2px 6px;
      border-radius:8px;
    }

    footer{
      background:#0a1a12;
      color:#cfe8da;
      padding:30px 0;
      margin-top:40px;
    }
    .foot{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:20px;
    }
    .foot a{color:#cfe8da}

    @media(max-width:980px){
      .kpis{grid-template-columns:repeat(2,1fr); margin-top:0}
      .dash{grid-template-columns:1fr}
      .side{position:relative; top:auto}
      .filters{grid-template-columns:1fr 1fr}
      .job{grid-template-columns:1fr}
      .cta{min-width:auto}
      .price,.sub{text-align:left}
      .links{display:none}
      .foot{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <!-- SENHA (simples) -->
  <script>
    (function(){
      var senha = prompt("√Årea exclusiva para parceiros. Digite a senha:");
      if (senha !== "JS2026") {
        alert("Senha incorreta.");
        window.location.href = "index.html";
      }
    })();
  </script>

  <div class="topbar">
    Portal do Parceiro JS ‚Ä¢ Dashboard de Servi√ßos (estilo ‚ÄúUber‚Äù)
  </div>

  <header>
    <div class="wrap nav">
      <a class="brand" href="index.html">
        <img src="logo branca limpa.png" alt="JS Jardinagem" />
        <strong>JS JARDINAGEM</strong>
      </a>

      <nav class="links">
        <a href="index.html">In√≠cio</a>
        <a href="carreira.html">Carreira</a>
        <a href="parceiros.html">Portal</a>
      </nav>

      <a class="btn btn-primary" href="parceiros.html">Voltar ao Portal</a>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero">
    <div class="wrap">
      <h1>Servi√ßos Dispon√≠veis</h1>
      <p>
        Abra, filtre e pegue um servi√ßo em segundos. Ao clicar em <strong>Pegar servi√ßo</strong>, voc√™ registra no formul√°rio.
        A JS confirma e muda o status para <strong>Reservado/Fechado</strong>.
      </p>

      <div class="pill-row">
        <a href="parceiros.html" class="pill">üè† Portal</a>
        <a href="https://docs.google.com/spreadsheets/d/1s6HLuXw7lntFtBQYCuL2umRU9LFu8mS3LT-mhXeZqFs/edit?usp=sharing" class="pill" target="_blank" rel="noopener">üóìÔ∏è Agenda</a>
        <a href="https://docs.google.com/spreadsheets/d/1y8U5iFLGK1W9RBrHXT5i-Tj_ioPDFAEPtyqm5dPdPRM/edit?usp=sharing" class="pill" target="_blank" rel="noopener">üìã Or√ßamentos</a>
        <a href="#lista" class="pill">üõ†Ô∏è Servi√ßos</a>
      </div>

      <div class="note">
        <strong>Autom√°tico:</strong> este dashboard pode ler uma aba ‚ÄúVIEW_PORTAL‚Äù publicada em CSV e atualizar sozinho (ex.: a cada 60s).
        Voc√™ s√≥ cola os links em <code>CONFIG</code> l√° embaixo.
      </div>
    </div>
  </section>

  <section id="lista">
    <div class="wrap">

      <!-- KPIs -->
      <div class="kpis">
        <div class="kpi">
          <p class="t">Servi√ßos dispon√≠veis</p>
          <p class="v" id="kpiAvailable">‚Äî</p>
          <p class="s">Atualizado: <span id="kpiUpdated">‚Äî</span></p>
        </div>
        <div class="kpi">
          <p class="t">Valor total (dispon√≠vel)</p>
          <p class="v" id="kpiValue">‚Äî</p>
          <p class="s">Somat√≥rio dos dispon√≠veis</p>
        </div>
        <div class="kpi">
          <p class="t">Bairros atendidos</p>
          <p class="v" id="kpiBairros">‚Äî</p>
          <p class="s">Cobertura atual</p>
        </div>
        <div class="kpi">
          <p class="t">Alta prioridade</p>
          <p class="v" id="kpiHigh">‚Äî</p>
          <p class="s">Urgentes / hoje</p>
        </div>
      </div>

      <div class="dash">
        <!-- LEFT -->
        <div class="panel">
          <div class="panel-head">
            <h2>Lista de ofertas</h2>
            <div class="right">
              <span class="conn"><span id="connDot" class="dot"></span><span id="connText">Conectando‚Ä¶</span></span>
              <button class="btn" id="btnRefresh" type="button">‚ü≥ Atualizar</button>
              <a class="btn btn-primary" id="btnOpenFormTop" href="#" target="_blank" rel="noopener">üì• Pegar servi√ßo</a>
            </div>
          </div>

          <!-- Filters -->
          <div class="filters">
            <div class="field">
              <span>üîé</span>
              <input id="qSearch" placeholder="Buscar: bairro, servi√ßo, cliente, tipo..." />
            </div>

            <div class="field">
              <span>üìç</span>
              <select id="fBairro">
                <option value="">Bairro (todos)</option>
              </select>
            </div>

            <div class="field">
              <span>üåø</span>
              <select id="fCategoria">
                <option value="">Categoria (todas)</option>
              </select>
            </div>

            <div class="field">
              <span>üî•</span>
              <select id="fPrioridade">
                <option value="">Prioridade (todas)</option>
                <option value="Alta">Alta</option>
                <option value="M√©dia">M√©dia</option>
                <option value="Baixa">Baixa</option>
              </select>
            </div>

            <div class="field">
              <span>‚úÖ</span>
              <select id="fStatus">
                <option value="Dispon√≠vel">Status: Dispon√≠vel</option>
                <option value="">Status (todos)</option>
                <option value="Reservado">Reservado</option>
                <option value="Fechado">Fechado</option>
                <option value="Em negocia√ß√£o">Em negocia√ß√£o</option>
              </select>
            </div>
          </div>

          <div class="cards" id="cards"></div>
          <div class="empty" id="empty">Nenhum servi√ßo encontrado com esses filtros.</div>
        </div>

        <!-- RIGHT -->
        <aside class="side">
          <div class="box">
            <h3>Como funciona</h3>
            <p>
              1) Voc√™ v√™ os servi√ßos <strong>Dispon√≠veis</strong>.<br/>
              2) Clica em <strong>Pegar servi√ßo</strong> no card.<br/>
              3) Abre um <strong>Formul√°rio</strong> e registra seu interesse.<br/>
              4) A JS confirma e atualiza o status na base.
            </p>

            <ul>
              <li>Use filtros por bairro/categoria para achar r√°pido.</li>
              <li>Alta prioridade aparece primeiro (padr√£o ‚ÄúUber‚Äù).</li>
              <li>Parceiro n√£o edita planilha (mais seguro).</li>
            </ul>

            <div class="row">
              <button class="btn btn-ghost" type="button" id="btnHelp">Como conectar</button>
              <button class="btn" type="button" id="btnAuto">Auto: ON</button>
            </div>

            <p style="margin-top:12px">
              <strong>Arquivo sugerido:</strong> <code>https://docs.google.com/spreadsheets/d/e/2PACX-1vT8Ksrg7iVCFEH-eNZKwzAEalV6iN5NN2srX65ORIfJv6jPZkgf6WbIua5sJrWfcS8aQL4wfGnDvIOq/pubhtml</code>)
            </p>
          </div>
        </aside>
      </div>

    </div>
  </section>

  <footer>
    <div class="wrap foot">
      <div>
        <strong>JS Jardinagem</strong>
        <p style="opacity:.8;margin:8px 0 0">
          Portal interno para parceiros operacionais ‚Ä¢ Padr√£o JS.
        </p>
      </div>
      <div>
        <p><a href="index.html">In√≠cio</a></p>
        <p><a href="carreira.html">Carreira</a></p>
        <p><a href="parceiros.html">Portal</a></p>
      </div>
    </div>
  </footer>

  <script>
    /************************************************************
     * CONFIG (edite s√≥ aqui)
     ************************************************************/
    const CONFIG = {
      // CSV publicado da aba "VIEW_PORTAL" (recomendado)
      // Google Sheets ‚Üí Arquivo ‚Üí Publicar na Web ‚Üí selecione a aba ‚Üí CSV ‚Üí Publicar ‚Üí copie o link
      DASH_CSV_URL: "",

      // Link do Google Form (Pegar Servi√ßo)
      FORM_URL: "https://docs.google.com/forms/d/e/SEU_FORM_ID/viewform",

      // (Opcional) Prefill do Form (para j√° abrir com dados do card)
      // Pegue os entry.xxxxx no "Obter link pr√©-preenchido" do Google Form
      FORM_PREFILL: {
        enabled: false,
        entryJobId: "",
        entryBairro: "",
        entryCategoria: "",
        entryServico: "",
        entryValor: "",
        entryPrioridade: ""
      },

      // Mapeamento das colunas (nomes exatos do cabe√ßalho na sua aba/CSV)
      COLUMNS: {
        id: "ID",
        status: "Status",
        bairro: "Bairro",
        categoria: "Categoria do servi√ßo solicitado",
        servico: "Descri√ß√£o detalhada do servi√ßo",
        area: "√Årea aproximada (m¬≤)",
        valor: "PRE√áO FINAL (R$)",
        urgencia: "Urg√™ncia",
        cliente: "Nome completo do cliente",
        endereco: "Endere√ßo do servi√ßo",
        data: "Carimbo de data/hora"
      },

      DEFAULT_STATUS_FILTER: "Dispon√≠vel",

      // Auto refresh (ms). Recomendado: 60000 (60s)
      AUTO_REFRESH_MS: 60000
    };

    /************************************************************
     * DADOS DEMO (usado se DASH_CSV_URL estiver vazio ou falhar)
     ************************************************************/
    const DEMO = [
      { ID:"JS-1027", Status:"Dispon√≠vel", Bairro:"Saraiva", "Categoria do servi√ßo solicitado":"Revitaliza√ß√£o",
        "Descri√ß√£o detalhada do servi√ßo":"Revitaliza√ß√£o completa + limpeza t√©cnica de canteiros", "√Årea aproximada (m¬≤)":"220",
        "PRE√áO FINAL (R$)":"1800", "Urg√™ncia":"Alta", "Nome completo do cliente":"Condom√≠nio X", "Endere√ßo do servi√ßo":"Av. ...", "Carimbo de data/hora":"2026-02-27 10:15" },
      { ID:"JS-1028", Status:"Dispon√≠vel", Bairro:"Alto Umuarama", "Categoria do servi√ßo solicitado":"Poda",
        "Descri√ß√£o detalhada do servi√ßo":"Poda de cerca viva (per√≠metro) + recolhimento", "√Årea aproximada (m¬≤)":"‚Äî",
        "PRE√áO FINAL (R$)":"650", "Urg√™ncia":"M√©dia", "Nome completo do cliente":"Residencial Y", "Endere√ßo do servi√ßo":"Rua ...", "Carimbo de data/hora":"2026-02-27 09:10" },
      { ID:"JS-1029", Status:"Reservado", Bairro:"G√°vea", "Categoria do servi√ßo solicitado":"Implanta√ß√£o",
        "Descri√ß√£o detalhada do servi√ßo":"Implanta√ß√£o de canteiros + forra√ß√£o", "√Årea aproximada (m¬≤)":"180",
        "PRE√áO FINAL (R$)":"3200", "Urg√™ncia":"Alta", "Nome completo do cliente":"Empresa Z", "Endere√ßo do servi√ßo":"Rua ...", "Carimbo de data/hora":"2026-02-26 16:40" }
    ];

    /************************************************************
     * UTIL
     ************************************************************/
    const $ = (sel) => document.querySelector(sel);
    const fmtBRL = (n) => {
      const x = Number(n);
      if (!isFinite(x)) return "‚Äî";
      return x.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    };
    const norm = (s) => String(s ?? "").trim();

    function parseNumber(v){
      const s = norm(v)
        .replace(/\s/g,"")
        .replace(/[R$\u00A0]/g,"")
        .replace(/\./g,"")
        .replace(",",".");
      const x = Number(s);
      return isFinite(x) ? x : NaN;
    }

    function badgeStatus(st){
      const x = norm(st).toLowerCase();
      if (x === "dispon√≠vel" || x === "disponivel") return `<span class="badge b-ok">Dispon√≠vel</span>`;
      if (x === "reservado") return `<span class="badge b-warn">Reservado</span>`;
      if (x === "fechado") return `<span class="badge b-bad">Fechado</span>`;
      if (x.includes("negoc")) return `<span class="badge b-warn">Em negocia√ß√£o</span>`;
      return `<span class="badge">${norm(st) || "‚Äî"}</span>`;
    }

    function badgePriority(u){
      const x = norm(u).toLowerCase();
      if (x === "alta" || x.includes("urg")) return `<span class="badge b-pri">Alta</span>`;
      if (x === "m√©dia" || x === "media") return `<span class="badge b-id">M√©dia</span>`;
      if (x === "baixa") return `<span class="badge b-id">Baixa</span>`;
      return `<span class="badge b-id">${norm(u) || "‚Äî"}</span>`;
    }

    function buildFormLink(row){
      if (!CONFIG.FORM_PREFILL.enabled) return CONFIG.FORM_URL;

      const pre = CONFIG.FORM_PREFILL;
      const cols = CONFIG.COLUMNS;
      const params = new URLSearchParams();

      if (pre.entryJobId) params.set(pre.entryJobId, norm(row[cols.id]));
      if (pre.entryBairro) params.set(pre.entryBairro, norm(row[cols.bairro]));
      if (pre.entryCategoria) params.set(pre.entryCategoria, norm(row[cols.categoria]));
      if (pre.entryServico) params.set(pre.entryServico, norm(row[cols.servico]));
      if (pre.entryValor) params.set(pre.entryValor, norm(row[cols.valor]));
      if (pre.entryPrioridade) params.set(pre.entryPrioridade, norm(row[cols.urgencia]));

      const base = CONFIG.FORM_URL.includes("?") ? CONFIG.FORM_URL + "&" : CONFIG.FORM_URL + "?";
      return base + params.toString();
    }

    /************************************************************
     * CSV parser (simples com aspas)
     ************************************************************/
    function parseCSV(text){
      const rows = [];
      let cur = "", inQ = false;
      const out = [];

      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"' && inQ && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQ = !inQ; continue; }
        if (ch === ',' && !inQ){ out.push(cur); cur=""; continue; }
        if ((ch === '\n' || ch === '\r') && !inQ){
          if (ch === '\r' && next === '\n') i++;
          out.push(cur); cur="";
          rows.push(out.splice(0, out.length));
          continue;
        }
        cur += ch;
      }
      if (cur.length || out.length){ out.push(cur); rows.push(out); }

      const clean = rows.filter(r => r.some(c => String(c ?? "").trim() !== ""));
      if (!clean.length) return [];

      const header = clean[0].map(h => String(h ?? "").trim());
      const data = [];
      for (let i=1;i<clean.length;i++){
        const obj = {};
        for (let j=0;j<header.length;j++){
          obj[header[j]] = clean[i][j] ?? "";
        }
        data.push(obj);
      }
      return data;
    }

    /************************************************************
     * STATE
     ************************************************************/
    let ALL = [];
    let VIEW = [];
    let autoOn = true;
    let autoTimer = null;

    function getFilters(){
      return {
        q: norm($("#qSearch").value).toLowerCase(),
        bairro: $("#fBairro").value,
        cat: $("#fCategoria").value,
        pri: $("#fPrioridade").value,
        st: $("#fStatus").value
      };
    }

    function fillFilterOptions(){
      const cols = CONFIG.COLUMNS;
      const bairroSet = new Set();
      const catSet = new Set();

      for (const r of ALL){
        const b = norm(r[cols.bairro]);
        const c = norm(r[cols.categoria]);
        if (b) bairroSet.add(b);
        if (c) catSet.add(c);
      }

      const bSel = $("#fBairro");
      const cSel = $("#fCategoria");

      bSel.innerHTML = `<option value="">Bairro (todos)</option>`;
      cSel.innerHTML = `<option value="">Categoria (todas)</option>`;

      [...bairroSet].sort((a,b)=>a.localeCompare(b,"pt-BR")).forEach(v=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        bSel.appendChild(o);
      });

      [...catSet].sort((a,b)=>a.localeCompare(b,"pt-BR")).forEach(v=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        cSel.appendChild(o);
      });
    }

    function applyFilters(){
      const f = getFilters();
      const cols = CONFIG.COLUMNS;

      VIEW = ALL.filter(r => {
        const status = norm(r[cols.status]);
        if (f.st && status !== f.st) return false;

        const bairro = norm(r[cols.bairro]);
        if (f.bairro && bairro !== f.bairro) return false;

        const cat = norm(r[cols.categoria]);
        if (f.cat && cat !== f.cat) return false;

        const pri = norm(r[cols.urgencia]);
        if (f.pri && pri !== f.pri) return false;

        if (f.q){
          const hay = [
            r[cols.id], r[cols.bairro], r[cols.categoria],
            r[cols.servico], r[cols.cliente], r[cols.endereco],
            r[cols.status], r[cols.urgencia]
          ].map(x => norm(x).toLowerCase()).join(" ‚Ä¢ ");
          if (!hay.includes(f.q)) return false;
        }
        return true;
      });

      // Ordena√ß√£o ‚ÄúUber‚Äù: prioridade alta ‚Üí maior valor ‚Üí mais recente
      const priRank = (u) => {
        const x = norm(u).toLowerCase();
        if (x === "alta" || x.includes("urg")) return 0;
        if (x === "m√©dia" || x === "media") return 1;
        if (x === "baixa") return 2;
        return 3;
      };

      VIEW.sort((a,b) => {
        const pa = priRank(a[cols.urgencia]);
        const pb = priRank(b[cols.urgencia]);
        if (pa !== pb) return pa - pb;

        const va = parseNumber(a[cols.valor]);
        const vb = parseNumber(b[cols.valor]);
        if (isFinite(vb) && isFinite(va) && vb !== va) return vb - va;

        const da = Date.parse(a[cols.data]) || 0;
        const db = Date.parse(b[cols.data]) || 0;
        return db - da;
      });

      render();
    }

    function render(){
      const cols = CONFIG.COLUMNS;
      const el = $("#cards");
      el.innerHTML = "";

      $("#empty").style.display = VIEW.length ? "none" : "block";

      // KPIs baseados nos dispon√≠veis (na base total)
      const available = ALL.filter(r => norm(r[cols.status]) === "Dispon√≠vel");
      const sum = available.reduce((acc,r) => acc + (parseNumber(r[cols.valor]) || 0), 0);
      const bairros = new Set(available.map(r => norm(r[cols.bairro])).filter(Boolean));
      const high = available.filter(r => {
        const u = norm(r[cols.urgencia]).toLowerCase();
        return u === "alta" || u.includes("urg");
      }).length;

      $("#kpiAvailable").textContent = String(available.length);
      $("#kpiValue").textContent = fmtBRL(sum);
      $("#kpiBairros").textContent = String(bairros.size);
      $("#kpiHigh").textContent = String(high);
      $("#kpiUpdated").textContent = new Date().toLocaleString("pt-BR");

      // Top form button
      $("#btnOpenFormTop").href = CONFIG.FORM_URL;

      for (const r of VIEW){
        const id = norm(r[cols.id]) || "‚Äî";
        const bairro = norm(r[cols.bairro]) || "‚Äî";
        const cat = norm(r[cols.categoria]) || "‚Äî";
        const serv = norm(r[cols.servico]) || "‚Äî";
        const area = norm(r[cols.area]) || "‚Äî";
        const urg = norm(r[cols.urgencia]) || "‚Äî";
        const st = norm(r[cols.status]) || "‚Äî";
        const cliente = norm(r[cols.cliente]) || "‚Äî";
        const end = norm(r[cols.endereco]) || "‚Äî";
        const valN = parseNumber(r[cols.valor]);
        const val = isFinite(valN) ? fmtBRL(valN) : (norm(r[cols.valor]) || "‚Äî");

        const formLink = buildFormLink(r);
        const canTake = (st === "Dispon√≠vel");

        const card = document.createElement("div");
        card.className = "job";
        card.innerHTML = `
          <div>
            <h3>${cat} ‚Ä¢ ${bairro}</h3>

            <div class="badges">
              ${badgeStatus(st)}
              <span class="badge b-id">ID: ${id}</span>
              ${badgePriority(urg)}
            </div>

            <div class="meta">
              <div class="kv">
                <p class="k">Servi√ßo</p>
                <p class="v">${serv}</p>
              </div>
              <div class="kv">
                <p class="k">Cliente/Local</p>
                <p class="v">${cliente}</p>
              </div>
              <div class="kv">
                <p class="k">√Årea</p>
                <p class="v">${area === "‚Äî" ? "‚Äî" : area + " m¬≤"}</p>
              </div>
            </div>

            <div class="meta" style="margin-top:10px">
              <div class="kv" style="grid-column: span 2;">
                <p class="k">Endere√ßo</p>
                <p class="v">${end}</p>
              </div>
              <div class="kv">
                <p class="k">Status</p>
                <p class="v">${st}</p>
              </div>
            </div>
          </div>

          <div class="cta">
            <p class="price">${val}</p>
            <p class="sub">valor estimado</p>

            ${
              canTake
                ? `<button class="btn-take" data-link="${encodeURI(formLink)}">üöÄ Pegar servi√ßo</button>`
                : `<button class="btn-mini" disabled style="opacity:.6;cursor:not-allowed">Indispon√≠vel</button>`
            }

            <button class="btn-mini" data-copy="${id}">üìã Copiar ID</button>
          </div>
        `;

        el.appendChild(card);
      }

      el.querySelectorAll(".btn-take").forEach(btn => {
        btn.addEventListener("click", () => {
          const link = decodeURI(btn.getAttribute("data-link"));
          if (!CONFIG.FORM_URL || CONFIG.FORM_URL.includes("SEU_FORM_ID")){
            alert("Configure o CONFIG.FORM_URL (link do Google Form) no fim do arquivo.");
            return;
          }
          window.open(link, "_blank", "noopener");
        });
      });

      el.querySelectorAll(".btn-mini[data-copy]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-copy");
          try{
            await navigator.clipboard.writeText(id);
            const old = btn.textContent;
            btn.textContent = "‚úÖ Copiado!";
            setTimeout(()=> btn.textContent = old, 1200);
          }catch(e){
            alert("N√£o consegui copiar automaticamente. ID: " + id);
          }
        });
      });
    }

    async function loadData(){
      const dot = $("#connDot");
      const text = $("#connText");

      // fallback demo
      const useDemo = (label, kind) => {
        ALL = DEMO.slice();
        dot.classList.remove("ok","bad");
        dot.classList.add(kind);
        text.textContent = label;
        fillFilterOptions();
        $("#fStatus").value = CONFIG.DEFAULT_STATUS_FILTER;
        applyFilters();
      };

      // no url => demo
      if (!CONFIG.DASH_CSV_URL){
        useDemo("Desconectado (demo)", "bad");
        return;
      }

      try{
        dot.classList.remove("ok","bad");
        text.textContent = "Conectando‚Ä¶";

        const res = await fetch(CONFIG.DASH_CSV_URL, { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const csv = await res.text();
        ALL = parseCSV(csv);

        dot.classList.add("ok");
        text.textContent = "Conectado (ao vivo)";

        fillFilterOptions();
        $("#fStatus").value = CONFIG.DEFAULT_STATUS_FILTER;
        applyFilters();
      }catch(err){
        console.error(err);
        useDemo("Falha na conex√£o (demo)", "bad");
      }
    }

    function setAuto(on){
      autoOn = on;
      const btn = $("#btnAuto");
      btn.textContent = autoOn ? "Auto: ON" : "Auto: OFF";
      btn.className = autoOn ? "btn btn-primary" : "btn btn-ghost";

      if (autoTimer) clearInterval(autoTimer);
      if (autoOn){
        autoTimer = setInterval(loadData, CONFIG.AUTO_REFRESH_MS);
      }
    }

    function bindUI(){
      ["#qSearch","#fBairro","#fCategoria","#fPrioridade","#fStatus"].forEach(sel=>{
        $(sel).addEventListener("input", applyFilters);
        $(sel).addEventListener("change", applyFilters);
      });

      $("#btnRefresh").addEventListener("click", loadData);

      $("#btnHelp").addEventListener("click", () => {
        alert(
`Como conectar (modo profissional):
1) Crie uma aba na planilha chamada VIEW_PORTAL (s√≥ campos necess√°rios).
2) Publique essa aba em CSV: Google Sheets ‚Üí Arquivo ‚Üí Publicar na Web ‚Üí CSV.
3) Cole o link CSV em CONFIG.DASH_CSV_URL.
4) Cole o link do Google Form em CONFIG.FORM_URL.
5) (Opcional) Gere link pr√©-preenchido do Form para abrir com ID/bairro/valor j√° preenchidos e habilite CONFIG.FORM_PREFILL.enabled = true.`
        );
      });

      $("#btnAuto").addEventListener("click", () => setAuto(!autoOn));
    }

    // BOOT
    bindUI();
    setAuto(true);
    loadData();
  </script>
</body>
</html>
